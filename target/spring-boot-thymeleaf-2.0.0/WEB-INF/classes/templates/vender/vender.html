<!DOCTYPE html>
<html lang="es" xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="master">
<script type="text/javascript" src="jquery-3.3.1.js"></script>
<body onload="checkMontoPolloFiambreOtros()" style="padding-top: 0px;">
<main layout:fragment="contenido">
    <div class="col-12">
        <h2>Vender</h2>
        <div th:classappend="'alert-' + (${clase != null} ? ${clase} : info)" th:if="${mensaje != null}"
             th:text="${mensaje}"
             class="alert">
        </div>

        <script>
            function jsShowWindowLoad(mensaje)
{
//Metodo que se Ejecuta 2

	//creamos el div que bloquea grande------------------------------------------
   var heads_var=	document.getElementsByTagName("body")[0];
   var div = document.createElement("div");
    div.id = "WindowLoad";
    //$('body', body).append(div);//window.parent.document).append(div); //---->Lo agregamos al body pero principal
heads_var.appendChild(div);

	//si no enviamos mensaje se pondra este por defecto
    if (mensaje === undefined) mensaje = "Procesando la información<br>Espere por favor";

    //centrar imagen gif
    height = 20;//El div del titulo, para que se vea mas arriba (H)
    var ancho = 0;
    var alto = 0;

     //obtenemos el ancho y alto de la ventana de nuestro navegador, compatible con todos los navegadores
    if (window.innerWidth == undefined) ancho = window.screen.width;
    else ancho = window.innerWidth;
    if (window.innerHeight == undefined) alto = window.screen.height;
    else alto = window.innerHeight;

     //operación necesaria para centrar el div que muestra el mensaje
    var heightdivsito =  alto/2 - parseInt(height)/2;//Se utiliza en el margen superior, para centrar

   //Aqui creamos el Spinner
    imgCentro = "<div style='text-align:center;height:" +  alto + "px;'>"
					+"<div  style='color:#000;margin-top:" + heightdivsito + "px; font-size:20px;font-weight:bold'>"
					+"</div>"
					+"<div class='load'>"
						+"<div class='gear one'>"
							+"<svg id='blue' viewbox='0 0 100 100' fill='#94DDFF'>"
								+"<path d='M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z'></path>"
							+"</svg>"
						+"</div>"
						+"<div class='gear two'>"
							+"<svg id='pink' viewbox='0 0 100 100' fill='#0093e1'>"
								+"<path d='M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z'></path>"
							+"</svg>"
						+"</div>"
						+"<div class='gear three'>"
							+"<svg id='yellow' viewbox='0 0 100 100' fill='#003f8e'>"
								+"<path d='M97.6,55.7V44.3l-13.6-2.9c-0.8-3.3-2.1-6.4-3.9-9.3l7.6-11.7l-8-8L67.9,20c-2.9-1.7-6-3.1-9.3-3.9L55.7,2.4H44.3l-2.9,13.6      c-3.3,0.8-6.4,2.1-9.3,3.9l-11.7-7.6l-8,8L20,32.1c-1.7,2.9-3.1,6-3.9,9.3L2.4,44.3v11.4l13.6,2.9c0.8,3.3,2.1,6.4,3.9,9.3      l-7.6,11.7l8,8L32.1,80c2.9,1.7,6,3.1,9.3,3.9l2.9,13.6h11.4l2.9-13.6c3.3-0.8,6.4-2.1,9.3-3.9l11.7,7.6l8-8L80,67.9      c1.7-2.9,3.1-6,3.9-9.3L97.6,55.7z M50,65.6c-8.7,0-15.6-7-15.6-15.6s7-15.6,15.6-15.6s15.6,7,15.6,15.6S58.7,65.6,50,65.6z'></path>"
							+"</svg>"
						+"</div>"
						+"<div class='lil-circle'></div>"
						+"<svg class='blur-circle'>"
							+"<filter id='blur'>"
								+"<fegaussianblur in='SourceGraphic' stddeviation='13'>"
								+"</fegaussianblur>"
							+"</filter>"
							+"<circle cx='70' cy='70' r='606' fill='transparent' stroke='#c8c8c8' stroke-width='40' filter='url(#blur)'>"
							+"</circle>"
						+"</svg>"
					+"</div>"	+ mensaje
				+"</div>";

        //creamos un input text para que el foco se plasme en este y el usuario no pueda escribir en nada de atras
        var input_var =	document.getElementById("WindowLoad");
		var input = document.createElement("input");
        input.id = "focusInput";
        input.type = "text"

	//creamos el div que bloquea grande------------------------------------------


          //asignamos el div que bloquea
       // $('#WindowLoad' , window.parent.document).append(input);
			input_var.appendChild(input);
			document.getElementById("focusInput").select();
			document.getElementById("focusInput").style.visibility = "hidden";
			document.getElementById("focusInput").style.display = "none";
          //asignamos el foco y ocultamos el input text
        //$('#focusInput' , window.parent.document).focus();
        //$('#focusInput' , window.parent.document).hide();

          //centramos el div del texto
        //$('#WindowLoad' , window.parent.document).html(imgCentro);
document.getElementById("WindowLoad").innerHTML = imgCentro;

		setTimeout(function(){ jsRemoveWindowLoad();
	/*			document.getElementById("tipo_consultaIPB3").value="B";
				document.getElementById("tipo_operacion").value="cVarios";
				document.forms[0].target = "_self";
				document.forms[0].method = "post";
				<!-- document.forms[0].action="OperacionCBTFServlet?proceso=registro_beneficiarias_consulta_pr&operacion=registro_beneficiarias_consulta_op&accion=consultar"; -->
				document.forms[0].action="CONSULTA - MANTENIMIENTO DE CTAS_DATOS DE LA CTA_PAG 2.html";
				document.forms[0].submit();*/}, 6000);
}
//-----------------------------------------------------------------------
//-----------------------------------------------------------------------

//-----Funcion para el Spiner y el div que bloquea la pantalla
//-----------------------------------------------------------------------
function jsRemoveWindowLoad()
{
//Metodo que se ejecuta 3
     // eliminamos el div que bloquea pantalla
	//$('#WindowLoad' , window.parent.document).remove
	var heads_var =	document.getElementsByTagName("body")[0];
	var input_var =	document.getElementById("WindowLoad");
	heads_var.removeChild(input_var);
}
//-----------------------------------------------------------------------
//-----------------------------------------------------------------------

        </script>

        <style>

#WindowLoad
{
    position:fixed;
    top:0px;
    left:0px;
    z-index:1000;
    filter:alpha(opacity=65);
   -moz-opacity:65;
    opacity:0.65;
    background:#c8c8c8;
	height:100%;
	width:100%;
}

.load {
  position: relative;
  margin: 50px auto;
  width: 100px;
  height: 80px;

}

.gear {
  position: absolute;
  z-index: -10;
  width: 40px;
  height: 40px;
  animation: spin 5s infinite;
}

.two {
  left: 40px;
  width: 80px;
  height: 80px;
  animation: spin-reverse 5s infinite;
}

.three {
  top: 45px;
  left: -10px;
  width: 60px;
  height: 60px;
}

@keyframes spin {
  50% {
    transform: rotate(360deg);
  }
}

@keyframes spin-reverse {
  50% {
    transform: rotate(-360deg);
  }
}


.lil-circle {
  position: absolute;
  border-radius: 50%;
  box-shadow: inset 0 0 10px 2px  rgb(155, 225, 251), 0 0 50px white;
  width: 100px;
  height: 100px;
  opacity: .65;
}

.blur-circle {
  position: absolute;
  top: -19px;
  left: -19px;
}

.text {
  color: lightgray;
  text-align: center;
}
    </style>


        <form id="form-agregarproducto" th:object="${producto}" th:action="@{/vender/agregarProductos}" method="post">

            <input hidden autofocus autocomplete="off" th:field="*{precio}" id="subtotalPolloRefresh" name="subtotalPolloRefresh"
                   type="number"
                   class="form-control">

            <input hidden autofocus autocomplete="off" th:field="*{existencia}" id="subtotalFiambreRefresh" name="subtotalPolloRefresh"
                   type="number"
                   class="form-control">

            <input hidden autofocus autocomplete="off" th:field="*{nombre}" id="subtotalOtrosRefresh" name="subtotalPolloRefresh"
                   type="text"
                   class="form-control">

            <div hidden id="precioRecibidoBackend" th:text="${precioBackend}"></div>
            <div hidden id="existenciaRecibidoBackend" th:text="${existenciaBackend}"></div>
            <div hidden id="nombreRecibidoBackend" th:text="${nombreBackend}"></div>

            <script>
            function checkMontoPolloFiambreOtros(){
            var montoPR = document.getElementById("precioRecibidoBackend").innerText;
            var montoFR = document.getElementById("existenciaRecibidoBackend").innerText;
            var montoOR = document.getElementById("nombreRecibidoBackend").innerText;
            if(montoPR!=""&&montoPR!=0){
                document.getElementById("subtotalPollo").value=montoPR;
                montoPollo();
                }
            if(montoFR!=""&&montoFR!=0){
                document.getElementById("subtotalFiambre").value=montoFR;
                montoFiambre();
                }
            if(montoOR!=""&&montoOR!=0){
                document.getElementById("subtotalOtros").value=montoOR;
                montoOtros();
                }
            }

                function persistirMontosDeAbajo(){
                document.getElementById("subtotalPolloRefresh").value=document.getElementById("subtotalPollo").value;
                document.getElementById("subtotalFiambreRefresh").value=document.getElementById("subtotalFiambre").value;
                document.getElementById("subtotalOtrosRefresh").value=document.getElementById("subtotalOtros").value;
                document.getElementById("form-agregarproducto").submit();
                }

                function persistirMontosDeAbajoAumentar(){
                document.getElementById("subtotalPolloRefreshAumentar").value=document.getElementById("subtotalPollo").value;
                document.getElementById("subtotalFiambreRefreshAumentar").value=document.getElementById("subtotalFiambre").value;
                document.getElementById("subtotalOtrosRefreshAumentar").value=document.getElementById("subtotalOtros").value;
                document.getElementById("form-aumentar").submit();
                }

                function persistirMontosDeAbajoDisminuir(){
                document.getElementById("subtotalPolloRefreshDisminuir").value=document.getElementById("subtotalPollo").value;
                document.getElementById("subtotalFiambreRefreshDisminuir").value=document.getElementById("subtotalFiambre").value;
                document.getElementById("subtotalOtrosRefreshDisminuir").value=document.getElementById("subtotalOtros").value;
                document.getElementById("form-disminuir").submit();
                }

                function persistirMontosDeAbajoQuitar(){
                document.getElementById("subtotalPolloRefreshQuitar").value=document.getElementById("subtotalPollo").value;
                document.getElementById("subtotalFiambreRefreshQuitar").value=document.getElementById("subtotalFiambre").value;
                document.getElementById("subtotalOtrosRefreshQuitar").value=document.getElementById("subtotalOtros").value;
                document.getElementById("form-quitar").submit();
                }

                function aumentarProducto(codigoProducto){
                //alert(codigoProducto);
                }
            </script>

            <div class="form-group">
                <label for="codigo">Código de barras</label>
                <input autofocus autocomplete="off" th:field="*{codigo}" id="codigo"
                       placeholder="Escanea el código o escríbelo y presiona Enter"
                       type="text"
                       class="form-control" th:classappend="${#fields.hasErrors('codigo')} ? 'is-invalid' : ''"
                onchange="persistirMontosDeAbajo()">
                <div class="invalid-feedback" th:errors="*{codigo}"></div>
            </div>
        </form>

        <!-- Iba aca Cobrar y despues total-->

        <div class="table-responsive">
            <table class="table table-bordered">
                <thead>
                <tr>
                    <th>Nombre</th>
                    <th>Código</th>
                    <th>Precio</th>
                    <th>Cantidad</th>
                    <th>Total</th>
                    <th style="text-align:center;">Quitar de lista</th>
                    <th style="text-align:center;">Sumar uno</th>
                    <th style="text-align:center;">Restar uno</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="producto, iterador : ${session.carrito}">
                    <td th:text="${producto.nombre}"></td>
                    <td id="codigoSeleccionado" th:text="${producto.codigo}"></td>
                    <td th:text="${producto.precio}"></td>
                    <td th:text="${producto.cantidad}"></td>
                    <td th:text="${producto.total}"></td>
                    <td style="text-align:center;">
                                <form id="form-quitar" th:object="${producto}" th:action="@{/vender/quitar/} + ${iterador.index}" method="post">

                                    <input hidden autofocus autocomplete="off" th:field="*{precio}" id="subtotalPolloRefreshQuitar" name="subtotalPolloRefreshQuitar"
                                           type="number"
                                           class="form-control">

                                    <input hidden autofocus autocomplete="off" th:field="*{existencia}" id="subtotalFiambreRefreshQuitar" name="subtotalPolloRefreshQuitar"
                                           type="number"
                                           class="form-control">

                                    <input hidden autofocus autocomplete="off" th:field="*{nombre}" id="subtotalOtrosRefreshQuitar" name="subtotalPolloRefreshQuitar"
                                           type="text"
                                           class="form-control">

                                    <button onclick="persistirMontosDeAbajoQuitar()" class="btn btn-danger"><i class="fa fa-trash"></i></button>
                                </form>
                    </td>
                    <td style="text-align:center;">
                        <form id="form-aumentar" th:object="${producto}" th:action="@{/vender/aumentarUnProducto/} + ${iterador.index}" method="post">

                            <input hidden autofocus autocomplete="off" th:field="*{precio}" id="subtotalPolloRefreshAumentar" name="subtotalPolloRefreshAumentar"
                                   type="number"
                                   class="form-control">

                            <input hidden autofocus autocomplete="off" th:field="*{existencia}" id="subtotalFiambreRefreshAumentar" name="subtotalPolloRefreshAumentar"
                                   type="number"
                                   class="form-control">

                            <input hidden autofocus autocomplete="off" th:field="*{nombre}" id="subtotalOtrosRefreshAumentar" name="subtotalPolloRefreshAumentar"
                                   type="text"
                                   class="form-control">

                            <button onclick="persistirMontosDeAbajoAumentar()" class="btn btn-success">+</button>
                        </form>
                    </td>
                    <td style="text-align:center;">
                        <form id="form-disminuir" th:object="${producto}" th:action="@{/vender/disminuirUnProducto/} + ${iterador.index}" method="post">

                            <input hidden autofocus autocomplete="off" th:field="*{precio}" id="subtotalPolloRefreshDisminuir" name="subtotalPolloRefreshDisminuir"
                                   type="number"
                                   class="form-control">

                            <input hidden autofocus autocomplete="off" th:field="*{existencia}" id="subtotalFiambreRefreshDisminuir" name="subtotalPolloRefreshDisminuir"
                                   type="number"
                                   class="form-control">

                            <input hidden autofocus autocomplete="off" th:field="*{nombre}" id="subtotalOtrosRefreshDisminuir" name="subtotalPolloRefreshDisminuir"
                                   type="text"
                                   class="form-control">

                            <button onclick="persistirMontosDeAbajoDisminuir()" class="btn btn-success">-</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>

        <br>
        <div class="form-group">
            <label for="codigo">Otras Ventas:</label>

            <script>
            var subtotalPollo=0;
            var subtotalFiambre=0;
            var subtotalOtros=0;
            var oculto=0;
            var mostrar=0;

                function montoPollo(){
subtotalPollo = parseFloat(document.getElementById("subtotalPollo").value);
if (isNaN(subtotalPollo)) subtotalPollo = 0;
oculto = parseFloat(document.getElementById("oculto").innerHTML);
mostrar = document.getElementById("mostrar").innerHTML="Total: "+parseFloat(subtotalFiambre+subtotalPollo+subtotalOtros+oculto);
}

                function montoFiambre(){
subtotalFiambre = parseFloat(document.getElementById("subtotalFiambre").value);
if (isNaN(subtotalFiambre)) subtotalFiambre = 0;
oculto = parseFloat(document.getElementById("oculto").innerHTML);
mostrar = document.getElementById("mostrar").innerHTML="Total: "+parseFloat(subtotalFiambre+subtotalPollo+subtotalOtros+oculto);
}

                function montoOtros(){
subtotalOtros = parseFloat(document.getElementById("subtotalOtros").value);
if (isNaN(subtotalOtros)) subtotalOtros = 0;
oculto = parseFloat(document.getElementById("oculto").innerHTML);
mostrar = document.getElementById("mostrar").innerHTML="Total: "+parseFloat(subtotalFiambre+subtotalPollo+subtotalOtros+oculto);
}


                function cobrarEfectivo(){

                var dineroCaja = document.getElementById("dineroCaja").value;
                var dineroDigital = document.getElementById("dineroDigital").value;
                var clienteCtaCte = document.getElementById("clienteCtaCte").value;
                var dineroCtaCte = document.getElementById("dineroCtaCte").value;

                if((dineroCaja!=null&&dineroCaja!='')||(dineroDigital!=null&&dineroDigital!='')||(dineroCtaCte!=null&&dineroCtaCte!=''&&clienteCtaCte!='Seleccione el cliente'))
                {

                var concatMedioDePago = dineroCaja+";"+dineroDigital+";"+dineroCtaCte+","+clienteCtaCte;
                //alert(concatMedioDePago);
                document.getElementById("concatMedioDePago").value=concatMedioDePago;


document.getElementById("myModal").style.zIndex = "0";

jsShowWindowLoad("Cargando...");
                    setTimeout(() => {
                    console.log("Retrasado por 1 segundo.");
                    document.getElementById("venderForm").submit();
                    }, "2000");



                //document.getElementById("venderForm").submit();
                 }
                else{
                    document.getElementById("ejecutarAdvertencia").click();
                }

             }

                function activarCuentaCorriente(){
                    document.getElementById("dineroCtaCte").disabled=false;
                }
            </script>

        </div>

        <form id="venderForm" th:object="${producto}" class="mb-2" th:action="@{/vender/cobrar/}+${precio}" method="post">
            <input hidden class="form-control" type="text" id="concatMedioDePago" name="concatMedioDePago" th:field="*{nombre}"/>
            <br>
            <input class="form-control"
                   type="number"
                   placeholder="Monto Polleria"
                   id="subtotalPollo"
                   name="subtotalPollo"
                   th:field="*{precio}"
                   onchange="montoPollo()" />
            <br>
            <input class="form-control"
                   type="number"
                   placeholder="Monto Fiambres y Quesos"
                   id="subtotalFiambre"
                   name="subtotalFiambre"
                   th:field="*{existencia}"
                   onchange="montoFiambre()" />
            <br>
            <input class="form-control"
                   type="number"
                   placeholder="Monto Otros"
                   id="subtotalOtros"
                   name="subtotalOtros"
                   th:field="*{codigo}"
                   onchange="montoOtros()" />
            <br>
            <br>

            <button type="button" class="btn btn-success" data-toggle="modal" data-target="#myModal">Cobrar <i class="fa fa-check"></i></button>
            </button>
            <a th:href="@{/vender/limpiar}" class="btn btn-danger">Cancelar venta <i class="fa fa-trash"></i>
            </a>
        </form>

        <h1 id="oculto" hidden th:text="${total}"></h1>
        <h1 id="mostrar" th:text="${'Total: '+ total}"></h1>
        <br>



    </div>


    <button id="ejecutarAdvertencia" hidden type="button" class="btn btn-success" data-toggle="modal" data-target="#myModalAdvertencia">EjecutarAdvertencia</button>
    <div class="container">
        <!-- Modal -->
        <div class="modal fade" id="myModal" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header" style="display:none;">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Medio de Pago</h4>
                    </div>
                    <div class="modal-body">

                        <p>Dinero en efectivo: </p>
                        <input class="form-control"
                               type="text"
                               placeholder="Ingrese el monto"
                               id="dineroCaja"
                               name="dineroCaja"/>
                        <br>

                        <p>Dinero digital: </p>
                        <input class="form-control"
                               type="number"
                               placeholder="Ingrese el monto"
                               id="dineroDigital"
                               name="dineroDigital"/>
                        <br>

                        <p>Dinero a cuenta corriente: </p>

                        <select id="clienteCtaCte" class="form-select" aria-label="Default select example" onchange="activarCuentaCorriente()">
                            <option value="0">Seleccione el cliente</option>
                            <option th:each="clienteCtaCte : ${clientesCuentaCorriente}" th:value="${clienteCtaCte.id}" th:text="${clienteCtaCte.nombre}"></option>
                        </select>

                        <!--<select id="clienteCtaCte" class="form-select" aria-label="Default select example" onchange="activarCuentaCorriente()">
                            <option selected>Seleccione el cliente</option>
                            <option value="1">Nestor y Yamila Nanni</option>
                            <option value="2">Mauricio Godoy</option>
                            <option value="3">Maria Irusta</option>
                            <option value="4">Adrian Ramirez</option>
                            <option value="5">Mingo</option>
                            <option value="6">Lili y Magui</option>
                            <option value="7">Juan Lencina</option>
                            <option value="8">Joha</option>
                            <option value="9">Alexia</option>
                            <option value="10">Nicole</option>
                            <option value="11">Mati & Sol</option>
                            <option value="12">Paolo</option>
                            <option value="13">Vanina</option>
                        </select>-->
                        <br>
                        <br>
                        <input disabled class="form-control"
                               type="number"
                               placeholder="Ingrese el monto"
                               id="dineroCtaCte"
                               name="dineroCtaCte"/>

                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-success" onclick="cobrarEfectivo()">Cobrar Venta <i class="fa fa-check"></i></button>
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancelar</button>
                    </div>

                </div>

            </div>
        </div>

    </div>


    <div class="container">
        <!-- Modal -->
        <div class="modal fade" id="myModalAdvertencia" role="dialog">
            <div class="modal-dialog">

                <!-- Modal content-->
                <div class="modal-content">
                    <div class="modal-header" style="display:none;">
                        <button type="button" class="close" data-dismiss="modal">&times;</button>
                        <h4 class="modal-title">Advertencia</h4>
                    </div>
                    <div class="modal-body">
                        <h2>Debe ingresar el medio de pago</h2>
                    </div>
                    <div class="modal-footer">
                            <button type="button" class="btn btn-default" data-dismiss="modal">Atras</button>
                    </div>

                </div>

            </div>
        </div>

    </div>

</main>
</body>
</html>